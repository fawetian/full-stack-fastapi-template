#!/bin/bash
# =============================================================================
# 非 Docker 更新脚本
# 用于日常代码更新和部署
# =============================================================================
# 使用方法:
#   sudo bash scripts/deploy/update-native.sh
# =============================================================================

set -e

# =============================================================================
# 配置区域
# =============================================================================

# 应用部署路径
APP_DIR="/var/www/fastapi-app"

# 运行用户
APP_USER="www-data"

# Git 分支
GIT_BRANCH="master"

# =============================================================================
# 脚本开始
# =============================================================================

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}  FastAPI 应用更新脚本${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# 检查 root 权限
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}请使用 sudo 运行此脚本${NC}"
    exit 1
fi

cd "$APP_DIR"

# -----------------------------------------------------------------------------
# 1. 拉取最新代码
# -----------------------------------------------------------------------------
echo -e "${YELLOW}[1/5] 拉取最新代码...${NC}"

# 保存当前提交
OLD_COMMIT=$(git rev-parse HEAD 2>/dev/null || echo "unknown")

# 拉取代码
git fetch origin
git checkout "$GIT_BRANCH"
git pull origin "$GIT_BRANCH"

NEW_COMMIT=$(git rev-parse HEAD)

if [ "$OLD_COMMIT" == "$NEW_COMMIT" ]; then
    echo -e "${GREEN}✓${NC} 代码已是最新版本"
else
    echo -e "${GREEN}✓${NC} 代码已更新: $OLD_COMMIT -> $NEW_COMMIT"
fi
echo ""

# -----------------------------------------------------------------------------
# 2. 更新后端依赖
# -----------------------------------------------------------------------------
echo -e "${YELLOW}[2/5] 更新后端依赖...${NC}"

cd "$APP_DIR/backend"

# 使用 uv 或 pip 更新依赖
if command -v uv &> /dev/null; then
    sudo -u "$APP_USER" uv sync
else
    sudo -u "$APP_USER" .venv/bin/pip install -e .
fi

echo -e "${GREEN}✓${NC} 后端依赖更新完成"
echo ""

# -----------------------------------------------------------------------------
# 3. 运行数据库迁移
# -----------------------------------------------------------------------------
echo -e "${YELLOW}[3/5] 运行数据库迁移...${NC}"

sudo -u "$APP_USER" .venv/bin/alembic upgrade head

echo -e "${GREEN}✓${NC} 数据库迁移完成"
echo ""

# -----------------------------------------------------------------------------
# 4. 重新构建前端
# -----------------------------------------------------------------------------
echo -e "${YELLOW}[4/5] 构建前端...${NC}"

cd "$APP_DIR/frontend"

# 更新依赖
npm install

# 构建
npm run build

echo -e "${GREEN}✓${NC} 前端构建完成"
echo ""

# -----------------------------------------------------------------------------
# 5. 重启服务
# -----------------------------------------------------------------------------
echo -e "${YELLOW}[5/5] 重启服务...${NC}"

# 重启后端服务
systemctl restart fastapi-backend

# 等待服务启动
sleep 3

# 检查服务状态
if systemctl is-active --quiet fastapi-backend; then
    echo -e "${GREEN}✓${NC} 后端服务已启动"
else
    echo -e "${RED}✗${NC} 后端服务启动失败"
    echo "查看日志: journalctl -u fastapi-backend -n 50"
    exit 1
fi

# 重载 Nginx（如果配置有变化）
nginx -t && systemctl reload nginx

echo ""

# -----------------------------------------------------------------------------
# 完成
# -----------------------------------------------------------------------------
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  更新完成!${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""
echo "当前版本: $(git rev-parse --short HEAD)"
echo ""
echo "查看服务状态: systemctl status fastapi-backend"
echo "查看服务日志: journalctl -u fastapi-backend -f"
